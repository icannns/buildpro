services:
  # MySQL Database
  db:
    image: mysql:8.0
    container_name: buildpro-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: buildpro_db
    ports:
      - "3307:3306"
    volumes:
      - db_data:/var/lib/mysql
      # Auto-run schema with all tables and enhancements on first startup
      - ./database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    networks:
      - buildpro-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      timeout: 20s
      retries: 10

  # API Gateway (Port 5000)
  api-gateway:
    build: ./services/api-gateway
    container_name: buildpro-api-gateway
    ports:
      - "5000:5000"
    environment:
      DB_HOST: db
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: buildpro_db
      PORT: 5000
      AUTH_SERVICE_URL: http://buildpro-auth-service:5004
      PROJECT_SERVICE_URL: http://buildpro-project-service:5003
      BUDGET_SERVICE_URL: http://buildpro-budget-service:5001
      MATERIAL_SERVICE_URL: http://buildpro-material-service:5002
      VENDOR_SERVICE_URL: http://buildpro-vendor-service:5005
    depends_on:
      db:
        condition: service_healthy
    networks:
      - buildpro-network

  # Auth Service (Port 5004)
  auth-service:
    build: ./services/auth-service
    container_name: buildpro-auth-service
    ports:
      - "5004:5004"
    environment:
      DB_HOST: db
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: buildpro_db
      PORT: 5004
      JWT_SECRET: your-secret-key-here
    depends_on:
      db:
        condition: service_healthy
    networks:
      - buildpro-network

  # Project Service (Port 5003)
  project-service:
    build: ./services/project-service
    container_name: buildpro-project-service
    ports:
      - "5003:5003"
    environment:
      DB_HOST: db
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: buildpro_db
      PORT: 5003
    depends_on:
      db:
        condition: service_healthy
    networks:
      - buildpro-network

  # Budget Service - Java (Port 5001)
  budget-service:
    build: ./services/budget-service
    container_name: buildpro-budget-service
    ports:
      - "5001:5001"
    environment:
      DB_HOST: db
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: buildpro_db
      PORT: 5001
    depends_on:
      db:
        condition: service_healthy
    networks:
      - buildpro-network

  # Material Service - Python (Port 5002)
  material-service:
    build: ./services/material-service
    container_name: buildpro-material-service
    ports:
      - "5002:5002"
    environment:
      DB_HOST: db
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: buildpro_db
      PORT: 5002
    depends_on:
      db:
        condition: service_healthy
    networks:
      - buildpro-network

  # Vendor Service (Port 5005)
  vendor-service:
    build: ./services/vendor-service
    container_name: buildpro-vendor-service
    ports:
      - "5005:5005"
    environment:
      DB_HOST: db
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: buildpro_db
      PORT: 5005
    depends_on:
      db:
        condition: service_healthy
    networks:
      - buildpro-network

  # GraphQL Server (Port 5006)
  server:
    build: ./server
    container_name: buildpro-graphql-server
    ports:
      - "5006:5006"
    environment:
      DB_HOST: db
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: buildpro_db
      PORT: 5006
    depends_on:
      db:
        condition: service_healthy
    networks:
      - buildpro-network

  # Frontend Client (Port 5173)
  client:
    build: ./client
    container_name: buildpro-client
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:5000
      VITE_GRAPHQL_URL: http://localhost:5006/graphql
    depends_on:
      - api-gateway
      - server
    networks:
      - buildpro-network

networks:
  buildpro-network:
    driver: bridge

volumes:
  db_data:
